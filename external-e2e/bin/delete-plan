#!/usr/bin/env ruby

# include the "lib" directory
File.expand_path(File.join(__dir__, "..", "lib")).tap {|pwd|
  $LOAD_PATH.unshift(pwd) unless $LOAD_PATH.include?(pwd)
}

# include the "common" directory
File.expand_path(File.join(__dir__, "..", "common")).tap {|pwd|
  $LOAD_PATH.unshift(pwd) unless $LOAD_PATH.include?(pwd)
}

require 'optparse'
require 'ostruct'
require 'aws/api-gateway'

options = OpenStruct.new()
OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [options]"
  opts.separator "Delete an api usage plan"

  opts.on('-c', '--credentials FILE', "Location of the credentials FILE to use.") do |s|
    options.credentials = s
  end

  opts.on("--plan PLAN_INFO", "Json representation of the plan") do |plan|
    require 'json'
    options.key = JSON.parse(File.read(plan))["id"]
  end

  opts.on("--allow-delete-stages", "If we should allow existing stages to be removed from the plan.") do |a|
    options.stages = true
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!(ARGV)

client = Fineo::Aws::ApiGateway.new(options.credentials, options.verbose)

client.delete_plan(options.key, options.stages)
