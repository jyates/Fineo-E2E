#!/usr/bin/env ruby
# Setup an external api key for e2e testing

# include the "lib" directory
File.expand_path(File.join(__dir__, "..", "lib")).tap {|pwd|
  $LOAD_PATH.unshift(pwd) unless $LOAD_PATH.include?(pwd)
}

# include the "common" directory
File.expand_path(File.join(__dir__, "..", "..", "common")).tap {|pwd|
  $LOAD_PATH.unshift(pwd) unless $LOAD_PATH.include?(pwd)
}

require 'setting-up'
include Fineo::E2E::SettingUp

options = parse(ARGV, "setup-key", "Set up an API key for E2E testing")

require 'aws/api-gateway'
client = Fineo::Aws::ApiGateway.new(options.credentials, options.verbose)

# create a key
key = client.create_key()
read = client.create_plan(options.read)

options.plans << read.id
# add the key to all the necessary plans
options.plans.each{|plan_id|
  client.add_to_plan(plan_id, key)
}

# Log the update information
output = {
  key: key.id
  read-plan: read.id
  plans: options.plans
}

require 'json'
file = File.join(__dir__, "read-api.json")
content = JSON.pretty_generate(output)
File.write(file, content)

puts "Wrote: \n#{content}\n to #{file}"
